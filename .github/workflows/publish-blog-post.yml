name: Publish Blog Post

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'Blog post filename (without .md extension, e.g., my-new-post)'
        required: true
        type: string
      title:
        description: 'Blog post title'
        required: true
        type: string
      author:
        description: 'Author name'
        required: true
        default: 'Nihesh Rachakonda'
        type: string
      date:
        description: 'Publication date (YYYY-MM-DD)'
        required: true
        type: string
      dateModified:
        description: 'Modified date (YYYY-MM-DD, optional - defaults to publication date)'
        required: false
        type: string
      excerpt:
        description: 'Short description/excerpt'
        required: true
        type: string
      tags:
        description: 'Comma-separated tags (e.g., "webdev, tutorial, nextjs")'
        required: true
        type: string
      content:
        description: 'Markdown content (the body of the blog post)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  publish:
    name: Create and Commit Blog Post
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Validate inputs
        run: |
          # Validate filename (no spaces, no special chars except hyphens)
          if ! echo "${{ inputs.filename }}" | grep -qE '^[a-z0-9-]+$'; then
            echo "Error: Filename must contain only lowercase letters, numbers, and hyphens"
            exit 1
          fi
          
          # Validate date format
          if ! echo "${{ inputs.date }}" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
            echo "Error: Date must be in YYYY-MM-DD format"
            exit 1
          fi
          
          # Validate dateModified if provided
          if [ -n "${{ inputs.dateModified }}" ]; then
            if ! echo "${{ inputs.dateModified }}" | grep -qE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
              echo "Error: dateModified must be in YYYY-MM-DD format"
              exit 1
            fi
          fi
          
          echo "Input validation passed!"
      
      - name: Create blog post file
        run: |
          FILENAME="${{ inputs.filename }}.md"
          FILEPATH="content/$FILENAME"
          
          # Check if file already exists
          if [ -f "$FILEPATH" ]; then
            echo "Blog post file already exists: $FILENAME"
            echo "This will update the existing file."
          fi
          
          # Convert comma-separated tags to YAML array format
          TAGS_INPUT="${{ inputs.tags }}"
          TAGS_ARRAY=$(echo "$TAGS_INPUT" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
          
          # Use dateModified if provided, otherwise use date
          DATE_MODIFIED="${{ inputs.dateModified }}"
          if [ -z "$DATE_MODIFIED" ]; then
            DATE_MODIFIED="${{ inputs.date }}"
          fi
          
          # Create the markdown file using printf to avoid shell expansion issues
          {
            echo "---"
            printf 'title: "%s"\n' "${{ inputs.title }}"
            printf 'author: "%s"\n' "${{ inputs.author }}"
            printf 'date: "%s"\n' "${{ inputs.date }}"
            printf 'dateModified: "%s"\n' "$DATE_MODIFIED"
            printf 'tags: %s\n' "$TAGS_ARRAY"
            printf 'excerpt: "%s"\n' "${{ inputs.excerpt }}"
            echo "---"
            echo ""
            printf '%s\n' "${{ inputs.content }}"
          } > "$FILEPATH"
          
          echo "Blog post created/updated: $FILEPATH"
          echo "filename=$FILENAME" >> $GITHUB_ENV
      
      - name: Validate blog post
        run: |
          npm run test:blog-posts
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add content/${{ env.filename }}
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish blog post: ${{ inputs.title }}"
            git push
            echo "Blog post published successfully!"
          fi
      
      - name: Output result
        run: |
          echo "âœ… Blog post published successfully!"
          echo "ğŸ“ File: content/${{ env.filename }}"
          echo "ğŸ“– Title: ${{ inputs.title }}"
          echo "ğŸ‘¤ Author: ${{ inputs.author }}"
          echo "ğŸ“… Date: ${{ inputs.date }}"
